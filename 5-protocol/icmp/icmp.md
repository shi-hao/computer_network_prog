# icmp数据包流转
<pre>
<以icmp包为例，分析包是如何流转>  
icmp用于测试网络上目标ip主机是否可达，因为icmp使用ip协议，所以一般认为其属于传输层  
协议。  
  
1.tcp/ip协议栈首先要查询系统的路由表，看如何路由数据，如果路由表中有对应的条目，  
那就按照路由表路由数据，ip包的源地址就填对应接口的地址，目的地址填写目标ip地址。  
  
路由表格式一般格式如下。  
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface  
0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 eno1  
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 docker0  
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0  
192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 eno1  
  
网卡信息如下。  
eno1      Link encap:Ethernet  HWaddr 4c:cc:6a:73:25:df    
          inet addr:192.168.0.129  Bcast:192.168.0.255  Mask:255.255.255.0  
          inet6 addr: fe80::739b:30b5:e922:384f/64 Scope:Link  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1  
          RX packets:4339206 errors:0 dropped:0 overruns:0 frame:0  
          TX packets:1219220 errors:0 dropped:0 overruns:0 carrier:0  
          collisions:0 txqueuelen:1000   
          RX bytes:915438564 (915.4 MB)  TX bytes:209410381 (209.4 MB)  
          Interrupt:16 Memory:dff00000-dff20000   
  
前三列分别是，目标网段，网关，子网掩码，最后一列是接口。路由器的路由表是通过路由协议生成的，  
路由协议简单来说就是路由器之间互相对话，交换自己的路由表。  
  
  
此处有几种情况需要分析：  
（1）如果路由表中第一列中有目标ip的网段，那么就按照路由表，ip包的源地址就填写对应接口的地址  
目的地址就填充目的ip地址。  
以ping 192.168.0.1为例，ip源为192.168.0.129，目的地址为192.168.0.1  
  
（2）如果路由表中第一列没有目标ip的网段，那么系统会按照路由表第一条处理，将数据包发送给网关，  
ip包的源地址填充为对应接口的地址，源地址填充为目的地址。  
以ping 192.168.2.1为例，ip源为192.168.0.129，目的地址为192.168.2.1  
  
2.然后需要添加mac头，源地址填写对应接口的mac地址，目的地址填写对应ip主机的mac地址。  
此处有基点需要说明。  
（1）系统本身维护了一个mac地址表，其格式大体如下。  
Address                  HWtype  HWaddress           Flags Mask            Iface  
192.168.0.90             ether   d4:3d:7e:a6:ab:ee   C                     eno1  
192.168.0.19             ether   b0:89:00:04:0b:14   C                     eno1  
192.168.0.1              ether   00:17:16:0a:39:06   C                     eno1  
192.168.0.91             ether   f4:4d:30:1c:71:08   C                     eno1  
192.168.0.115            ether   54:ee:75:5f:ec:03   C                     eno1  
192.168.0.195            ether   54:ee:75:f8:94:d2   C                     eno1  
192.168.0.120            ether   70:20:84:0c:60:2c   C                     eno1  
192.168.0.61             ether   50:7b:9d:04:25:6d   C                     eno1  
192.168.0.117            ether   18:03:73:b4:00:47   C                     eno1  
第一列是对应主机的ip地址，第三列是其对应的mac地址。系统的mac地址表可以通过arp协议来产生。  
  
（2）如果mac地址表中有对应的条目，那么mac地址就填写对应ip的mac地址。  
以ping 192.168.0.1为例，mac源为4c:cc:6a:73:25:df，目的地址为00:17:16:0a:39:06  
  
（3）如果mac地址表中没有对应条目，那么系统对通过arp协议来获取对应主机的地址。  
以ping 192.168.0.100为例，系统会向网络发送arp广播包来获取对应主机的mac地址，arp成功后，mac目的地址就  
填写对应地址;如果arp失败，那么这个ip就无法发送出去，系统会报错。  
  
（4）如果ip包被发给网关了，mac地址如何填写呢？  
以ping 192.168.2.1为例，ip源为192.168.0.129，目的地址为192.168.2.1，  
                        mac源为4c:cc:6a:73:25:df，mac目的地址填写网关的mac地址。  
  
3.ip头，mac头填充完毕，数据会被发送到对应的网口上，发送出去。  
</pre>

**icmp报文格式**  

