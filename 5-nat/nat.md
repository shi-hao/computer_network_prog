# NAT(Network Address Translation)网络地址转换      
  
## what is NAT and used for?  
名词解释：NAT，network address translation网络地址转换。  
  
用途：主要作用是实现将IP包中的源/目的IP地址替换为另一个IP地址。  
通常是将IP包局域网私网地址转换为可路由公网地址。  
  
**NAT是网络地址转换，不是协议，所以没有包格式。**  
  
## how NAT works?  
NAT技术细节，各个厂家的设备可能都略微有差异，名称上也不太统一。      
简单来说，可以将所有的NAT分为SNAT和DNAT。      
SNAT ： 将IP数据包的源地址替换为指定地址。      
DNAT ： 将IP数据包的目的地址替换为指定地址。      
  
当路由器一个接口收到IP包后，查看本地路由表进行转发。当接口启用了NAT后，路由器  
会将IP包的源IP地址替换为接口的IP地址，然后转发出去。当收到反向的包时，查询NAT  
映射表，将目的IP地址替换为对应的映射前的IP地址。  
不同的主机通过NAT后，如何区分回来的IP包是去向哪个主机，NAT同时将TCP/UDP的端口  
号进行统一映射管理，来区分回包的目的主机。  
  
NAT映射表根据收到的TCP/UDP包的源端口，源IP地址生成。  
<pre>  
NAT Mapping Table  
-------------------------------------------------------------------  
|original_IP    protocol  original_Port  |NAT_IP           NAT_Port  
|----------------------------------------|----------------------------  
|192.168.1.100  TCP       9000           |192.168.2.100    6000  
|192.168.1.100  UDP       8000           |192.168.2.100    6001  
--------------------------------------------------------------------  
</pre>  
    
## Q&A
思考1：为什么要NAT？    
NAT解决了公网IP地址不足的问题，通过NAT，多台主机可以共享一个IP地址来访问其    
他网段，核心思想是将TCP/UDP端口号分配给其他主机。    
NAT一定程度上增强了网络安全性，可以仅仅暴露内网一台主机的指定TCP/UDP端口到外网。    
    
思考2：为什么要记录端口号呢？      
在一台PC上，端口的作用是区分TCP/UDP包是发给哪个应用程序的，NAT记录端口号的目的      
是为了区分TCP/UDP回包是发给哪个PC设备的。所以在当源地址不同，源端口相同时，NAT      
会改变源端口为另外一个端口。有时，NAT会将所有的源端口都改掉，统一规划。      
    
思考3：NAT会改变源MAC地址吗？      
NAT Table是不包含MAC地址映射关系这一项的，但是NAT转换完地址和端口号后，会将IP数      
据包重新打包从另一个端口发出，此时，IP协议栈会重新加MAC头，此时的MAC地址自然会      
被替换为对应接口的MAC，所以源MAC地址也变了，但是这种变化并不是NAT直接去改变的。        
    
思考4：NAT兼容ICMP协议吗？    
NAT对使用TCP/UDP的协议有很好的兼容性，但是ICMP不使用TCP/UDP，NAT是否兼容呢？    
在ICMP协议字段中，有和端口号类似的字段，即identifier字段，这个字段可以起到和    
端口号相同的功能，所以，NAT是兼容ICMP协议的。    
    
<实验：家用路由上网原理>      
家用路由器基本上可以理解为双口路由器 + 交换机。  
<pre>  
WAN口启用NAT，另一个LAN口是内网网关。  
------------------------  
|      WAN(NAT)        |  
|router                |  
|      LAN(网关)       |  
------------------------  
          ||  
-------------------------  
|switch                 |  
|lan1 |lan2 |lan3 |lan4 |  
-------------------------  
</pre>  
