# 网络协议                    
网络层的核心协议是网络协议(internet protocol)。  

## What is Internet Protocol and used for?
IP:internet protocol, 网络协议
  
## IP Packet    
<pre>    
IPv4 Header    
---------------------------------------------    
|ver  |IHL |DSCP|ECN|total length           |    
|4b   |4b  |6b  |2b |2 bytes                |    
---------------------------------------------    
|identification     |flags|fragment offset  |    
|2 bytes            |3bits|13bits           |    
--------------------------------------------    
|ttl     |protocol  |Header checksum        |    
|8 bits  |8 bits    |2 bytes                |    
---------------------------------------------    
|source IP address                          |    
|4 bytes                                    |    
---------------------------------------------    
|destination IP address                     |    
|4 bytes                                    |    
---------------------------------------------    
|options (up to 32 bits)                    |    
---------------------------------------------    
</pre>    
version:for IPv4, this is always equal to 4.      
IHL:internet header length      
DSCP:Differentiated Services Code Point(QoS)       
ECN:Explicit Congestion Notification      
total length:2字节，最大长度是65535    
    
identification/flags/fragment offset    
这三个字段是IP包分片机制，虽然IP包的最大长度可以    
是65535，但是二层的以太网帧最大允许的payload长度    
是1500，所以payload大于1500的IP是无法通过一个以太    
网帧发送的，这三个参数用于将大于1500字节的IP包进行    
分片，然后再传入二层进行组包。    
    
ttl:time to live      
protocol:payload的协议类型    
header checksum:头部数据的校验，不包含payload    
    
### IP地址   
IP协议的核心字段是IP地址。    
  
#### IP地址组成  
IPv4地址：4字节数据，由网络号 + 主机号组成，左边是网络号，右边是主机号                    
IPv6地址：8字节数据                    
        
网络号：可以理解为网络编号，是主机所属网络的代号。        
主机号：区分网络内不同主机的编号。        
掩码：为了区分网络号和主机号，从IP地址中提取网络号， IP & 掩码 = 网络号                      
  
#### IP地址表示方法  
一般使用IP加掩码位数的方法来表示网段，比如，                  
192.168.1.0/24                  
主机号全0，用来表示本网段。                  
主机号全1，用来表示本网段的广播地址。                  
其他的主机号都可以用来分配给网络内所有的计算机，即单播地址。                  
        
#### IP地址分类        
根据网络号的比特位长度(8/16/24/32)，将IP地址划分为A/B/C/D/E五类。        
有些IP地址可以在公共网络内使用，称作公网地址。  
有些IP地址只能在局域网内使用，称作私网地址。  
和MAC地址类似，IP地址也分为单播地址，组播地址，广播地址。  
<pre>
------------------------------------------------  
|单播地址：A/B/C类IP地址中，除了主机号全0和全1的地址  
|组播地址：D类IP地址  
|广播地址：A/B/C类IP地址中，主机号全1的地址，255.255.255.255也是广播地址  
------------------------------------------------  
</pre>
                  
1.A类地址                  
<pre>  
------------------------------------------------------  
定义  |网络号首字节最高位必须为0，8位掩码 255.0.0.0                    
范围  |1.x.x.x - 127.x.x.x                    
主机数|容纳主机数量2的24次方                    
公私网|10.x.x.x 为私网地址，其他可作为公网地址使用                      
其他  |127.x.x.x保留                    
------------------------------------------------------  
</pre>  
                    
2.B类地址                  
<pre>  
------------------------------------------------------  
定义  |网络号首字节最高位，次高位必须是1和0，16位掩码 255.255.0.0                    
范围  |128.0.x.x - 191.255.x.x                       
主机数|容纳主机数量2的16次方                    
公私网|172.16.x.x - 172.31.x.x 为私网地址，其他可作为公网地址使用                        
------------------------------------------------------  
</pre>  
  
3.C类地址                  
<pre>  
-----------------------------------------------------------  
定义  |网络号首字节高三位必须是110，24位掩码 255.255.255.0                    
范围  |192.0.0.x - 223.255.255.x                    
主机数|容纳主机数量2的8次方                    
公私网|192.168.x.x 为私网地址，其他可作为公网地址使用                     
-----------------------------------------------------------  
</pre>  
  
4.D类地址                    
<pre>  
-----------------------------------------  
定义  |组播地址，四个字节全部表示网络号。                  
范围  |224.0.0.0 - 239.255.255.255                  
主机数| 0   
-----------------------------------------  
</pre>  
  
  
5.E类地址                    
<pre>  
------------------------------------------------  
定义  |保留地址  
范围  |240.0.0.0 - 255.255.255.255          
------------------------------------------------  
</pre>  
                
#### 划分子网/子网掩码                    
子网划分的意义？        
在给定一段A/B/C类IP地址的前提下，网络内可容纳主机的个数是固定的，为了便于管理，      
在已有掩码的基础上，扩展掩码的位数，将网络划分成更小的网络，即将主机号高字节中      
的高位也用作网络号。      
      
实际应用，比如某公司做网络规划，给定一网段192.168.1.0/24，需要两个部门使用，将      
网络划分为两个子网，最高位用作网络号，192.168.1.0/25，192.168.1.128/25，可用IP      
地址都是128个（实际上是126个）。      
      
经过划分子网后，本来可以直接互通的IP地址，在IP层面则属于不同网段，不能直接通信了。      
比如192.168.1.1/24和192.168.128/24本来都属于C类地址，在进行IP通信时，下层会直接arp      
广播，然后直接通信，修改掩码后，下层则不进行arp广播了，而是要发给网关。        
  
**进制转换**  
二进制/十进制/十六进制  
为了计量物品的数量，人类发明了数字，十进制是一项伟大的发明，阿拉伯数字是一项伟大的发明。  
日常生活中，阿拉伯十进制数字全球通用，为了便捷使用，背诵9乘9乘法表几乎是全球小学必学内容。  
在计算机领域二进制和十六进制则使用最多，使用八位二进制，三者之间的转化使用也很频繁。  
1.十进制转二进制，十六进制  
这个不是很常用，一般需要借助笔算，方法是除以2/16然后取余数的方法来做。  
  
2.二进制转十进制  
常用，需要理解性的记忆。  
(1)按权展开求和  
将二进制的每一位乘以权然后相加得到对应的十进制数。  
  
(2)n位二进制  
n位二进制的表示范围是多少？  
是2的n次方个数字，范围是0-2的n次方减去1  
  
(3)第n位二进制  
第n位二进制表示十进制的数字是2的(n-1)次方  
  
3.二进制和十六进制转换  
八位二进制转换为两位十六进制快算很简单。  
将八位二进制分为两组，一组四位，四位二进制可以转换为一位十六进制。  
逆向，则一位十六进制转换为四位二进制。  

## Sequence
      
## Linux设置IP地址              
系统ubuntu18.04下，如何手动设置IP地址？                
1.使用指令                
基本步骤如下：                
ifconfig  [interface]  down               
ifconfig  [interface]  [ip]  netmask  [mask]               
route add default gw [gateway_ip] [interface]             
ifconfig  [interface]  up               
            
**手动配置有线网卡的地址？**            
在ubuntu18下使用指令配置网卡地址时，出现过很多奇怪的现象，比如使用ifconfig配置IP后，              
IP会自动丢失；IP配置好后，内核没有生成对应的路由，导致配置网关失败，也无法正常通信。                
个人感觉，手动配置IP地址跟系统的network-manager软件可能存在冲突，导致网络故障，所以              
ubuntu18下，手动修改IP可以考虑使用network-manager。如果确实需要使用命令行，那么建议              
先把network-manager网络配置中，对应的网卡配置关闭，然后再使用命令行配置。              
            
**手动配置无线网卡的地址？**            
ubuntu下，连接上无线网络后，network-manager会通过DHCP获取地址，如果DHCP获取地址失败，            
network-manager会认为网络连接失败，会自动断开无线连接，这种模式跟很多支持wifi的无线            
设备类似，所以为了手动配置无线网卡的地址，必须将network-manager中，dhcp地址关闭，才            
不会导致因为获取不到地址而断开wifi连接。            
              
2.使用network-manager              
ubuntu18图形化网络管理软件，配置好IP，需要重启网卡，使配置尽快生效。                
    
## Q&A  
问：网络设备的MAC地址原则上是必须全球唯一的，那么为什么不直接使用MAC地址通信，而是又在      
    三层设计IP地址，为什么使用这种双地址的架构？      
答：从技术实现的角度说：MAC地址属于二层地址，数据是根据目的MAC直接转发，属于一个广播域，    
    如果全球所有的设备通过交换机连接，那么一旦交换机泛洪，那么会消耗巨大的通信带宽，网络    
	会瘫痪，所以二层适合局域网内通信，三层IP地址，解决了网络之间的通信问题，路由器可以隔    
	离广播域，通过IP地址可以实现不同网络内主机端到端之间的通信。    
