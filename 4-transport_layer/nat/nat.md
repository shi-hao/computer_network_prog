# NAT     
  
## 1.What is NAT and used for?    
名词解释：NAT，network address translation网络地址转换。    
  
用途：主要作用是实现将IP包中的源/目的IP地址替换为另一个IP地址。    
通常是将IP包局域网私网地址转换为可路由公网地址。    
  
## 2.NAT Packet  
**NAT是网络地址转换，不是协议，所以没有包格式。**    
  
## 3.Sequence   
无    
  
## 4.How NAT works?      
NAT技术细节，各个厂家的设备可能都略微有差异，名称上也不太统一。        
简单来说，可以将所有的NAT分为SNAT和DNAT。        
SNAT ： 将IP数据包的源地址，端口号替换为指定地址，端口号。        
DNAT ： 将IP数据包目的地址，端口号替换为指定地址，端口号。        
  
<pre>
根据IP数据包目的IP地址处理数据包。    
(1)目的IP地址是：接口IP地址/组播地址/广播地址    
   先匹配NAT映射表，进行DNAT转换，然后匹配本地路由表进行转发。  
   匹配失败，则去掉IP头，转到传输层进一步处理。  
(2)目的IP地址是：其他单播地址    
   路由设备会匹配本地路由表，根据路由表转发，匹配不到则丢弃。   
   如果接口启用了NAT，那么在转发时，先进行SNAT转换。    
</pre>
  
## 5.NAT Mapping Table  
NAT映射表根据收到的TCP/UDP包的源端口，源IP地址生成。    
<pre>    
NAT Mapping Table    
--------------------------------------------------------------------------------    
|original_IP    protocol  original_Port  |NAT_IP           protocol   NAT_Port    
|----------------------------------------|--------------------------------------    
|192.168.1.100  TCP       9000           |192.168.2.100    TCP        6000    
|192.168.1.100  UDP       8000           |192.168.2.100    UDP        6001    
--------------------------------------------------------------------------------    
</pre>    
  
## 6.Q&A  
思考1：为什么要NAT？      
NAT解决了公网IP地址不足的问题，通过NAT，多台主机可以共享一个IP地址来访问其      
他网段，核心思想是将TCP/UDP端口号分配给其他主机。      
NAT一定程度上增强了网络安全性，可以仅仅暴露内网一台主机的指定TCP/UDP端口到外网。      
  
思考2：为什么要记录端口号呢？        
在一台PC上，端口的作用是区分TCP/UDP包是发给哪个应用程序的，NAT记录端口号的目的        
是为了区分TCP/UDP回包是发给哪个PC设备的。所以在当源地址不同，源端口相同时，NAT        
会改变源端口为另外一个端口。有时，NAT会将所有的源端口都改掉，统一规划。        
  
思考3：NAT会改变源MAC地址吗？        
NAT Table是不包含MAC地址映射关系这一项的，但是NAT转换完地址和端口号后，会将IP数        
据包重新打包从另一个端口发出，此时，IP协议栈会重新加MAC头，此时的MAC地址自然会        
被替换为对应接口的MAC，所以源MAC地址也变了，但是这种变化不是NAT改变的。          
  
思考4：NAT兼容ICMP协议吗？      
NAT对使用TCP/UDP的协议有很好的兼容性，但是ICMP不使用TCP/UDP，NAT是否兼容呢？      
在ICMP协议字段中，有和端口号类似的字段，即identifier字段，这个字段可以起到和      
端口号相同的功能，所以，NAT是兼容ICMP协议的。      
  
<实验：家用路由上网原理>        
家用路由器基本上可以理解为双口路由器 + 交换机。    
<pre>    
WAN口启用NAT，另一个LAN口是内网网关。    
------------------------    
|      WAN(NAT)        |    
|router                |    
|      LAN(GW)         |    
------------------------    
||    
-------------------------    
|switch                 |    
|lan1 |lan2 |lan3 |lan4 |    
-------------------------    
</pre>    
